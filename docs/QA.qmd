---
title: "QA and Comparison"
author: "Jiaojiao He"
date: "2023-05-15"
output: 
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
---

```{r setup, include = FALSE}
knitr::opts_knit$set(autodep = TRUE)
library(DEP)
library(vsn)
library(pheatmap)
library(tidyverse)
library(imputeLCMD)
library(SparseArray)
library(SummarizedExperiment)
source("missing_helper.R")
source("models.R")
```

# Number of detection

```{r, fig.height = 10, fig.width = 9, warning = FALSE}
load("output/seDiann.RData")
smpAnno <- colData(seDiann) %>% as_tibble(rownames = "smpID") 
numDetect.diann <- tibble(smpID = colnames(seDiann),
                          DIANN = colSums(!is.na(assay(seDiann))))

diagOrd <- colData(seDiann) %>% as_tibble(rownames = "smpID") %>% group_by(diag) %>%
  summarise(n = length(smpID)) %>% arrange(desc(n)) %>%
  pull(diag)

load("output/seSpec.RData")

numDetect.spec <- tibble(smpID = colnames(seSpec),
                         Spectronaut = colSums(!is.na(assay(seSpec))))

plotCom <- left_join(numDetect.diann, numDetect.spec) %>% left_join(smpAnno)  %>%
  mutate(condition = factor(diag, levels = diagOrd))

ggplot(plotCom, aes(x = Spectronaut, y = DIANN)) +
  geom_point(aes(col = condition), size=5) +
  theme_bw() +
  xlab("Number of proteins by Spectronaut") +
  ylab("Number of proteins by DIANN") +
  geom_abline(slope = 1, intercept = 0, color = "red") +
  xlim(0, 8000) + ylim(0, 8000) +
  theme(legend.position = "bottom",
        axis.text = element_text(size = 18),
        axis.title = element_text(size = 20))
# ggsave("protNumCompare.pdf", height = 10, width = 9)

ggplot(plotCom, aes(x = Spectronaut, y = DIANN)) +
  geom_point(aes(col = pelletSize), size=5) +
  theme_bw() +
  xlab("Number of proteins by Spectronaut") +
  ylab("Number of proteins by DIANN") +
  geom_abline(slope = 1, intercept = 0, color = "red") +
  xlim(0,8000) + ylim(0,8000) +
  theme(legend.position = "bottom",
        axis.text = element_text(size=18),
        axis.title = element_text(size=20))
# ggsave("protNumCompare_pellet.pdf", height = 10, width = 9)
```

# Median expression

## Before normalization, already log2 inside SE object

```{r}
medTab.diann <- tibble(smpID = colnames(seDiann),
                       DIANN = colMedians(assays(seDiann)$log2, na.rm = TRUE))

medTab.spec <- tibble(smpID = colnames(seSpec),
                      Spectronaut = colMedians(assays(seSpec)$log2, na.rm = TRUE))

comTab <- left_join(medTab.diann, medTab.spec) %>% left_join(smpAnno) %>% 
  pivot_longer(c(DIANN, Spectronaut), names_to = "software", values_to = "medVal") %>%
  mutate(condition = factor(diag, levels = diagOrd))
```

Point plot

```{r, fig.height = 10, fig.width = 9, warning = FALSE}
medComTab <- left_join(medTab.diann, medTab.spec) %>% left_join(smpAnno) %>%
  mutate(condition = factor(diag, levels = diagOrd))
ggplot(medComTab, aes(x=Spectronaut,y = DIANN)) +
  geom_point(aes(col = condition), size = 5)  +
  theme_bw() +
  xlab("Median expression by Spectronaut") +
  ylab("Median expression by DIANN") +
  #geom_abline(slope = 1, intercept = 0, color = "red") +
  #xlim(0,8000) + ylim(0,8000) +
  theme(legend.position = "bottom",
        axis.text = element_text(size = 18),
        axis.title = element_text(size = 20))

# ggsave("medCompare.pdf", height = 10, width = 9)

ggplot(medComTab, aes(x = Spectronaut, y = DIANN)) +
  geom_point(aes(col = pelletSize), size = 5)  +
  theme_bw() +
  xlab("Median expression by Spectronaut") +
  ylab("Median expression by DIANN") +
  #geom_abline(slope = 1, intercept = 0, color = "red") +
  #xlim(0,8000) + ylim(0,8000) +
  theme(legend.position = "bottom",
        axis.text = element_text(size = 18),
        axis.title = element_text(size = 20))

# ggsave("medCompare_pellet.pdf", height = 10, width = 9)
```

Boxplot

```{r}
ggplot(comTab, aes(x = condition, y = medVal)) +
  geom_boxplot(outlier.shape = NA) +
  ggbeeswarm::geom_quasirandom(aes(col = condition)) +
  facet_wrap(~software, ncol = 1, scale = "free_y") + 
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
        legend.position = "none",
        plot.title = element_text(hjust = 0.5)) +
  labs(y = "median expression", title = "Before normalization")

# ggsave("medVal_beforeVsn.pdf", height = 5, width = 6)
```

## After normalization

```{r}
diannMat <- assays(seDiann)$count
diannMat <- diannMat[rowSums(is.na(diannMat))/ncol(diannMat) < 0.5, ]
dim(diannMat)
diannMat.vst <- justvsn(diannMat)

specMat <- assays(seSpec)$count
specMat <- specMat[rowSums(is.na(specMat))/ncol(specMat) < 0.5, ]
dim(specMat)
specMat.vst <- justvsn(specMat)

medTab.diann <- tibble(smpID = colnames(diannMat),
                       DIANN = colMedians(diannMat.vst, na.rm=TRUE))

medTab.spec <- tibble(smpID = colnames(specMat),
                      Spectronaut = colMedians(specMat.vst, na.rm=TRUE))

comTab.vst <- left_join(medTab.diann, medTab.spec) %>% left_join(smpAnno) %>% 
  pivot_longer(c(DIANN,Spectronaut), names_to = "software", values_to = "medVal") %>%
  mutate(condition = factor(diag, levels = diagOrd))
```

```{r}
ggplot(comTab.vst, aes(x = condition, y = medVal)) +
  geom_boxplot(outlier.shape = NA) +
  ggbeeswarm::geom_quasirandom(aes(col= condition)) +
  facet_wrap(~software, ncol = 1, scale = "free_y") + 
  theme_bw() +
  labs(y = "median expression", title = "After vsn") + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
        legend.position = "none",
        plot.title = element_text(hjust = 0.5))

# ggsave("medVal_afterVsn.pdf", height = 5, width = 6)
```

# Missing value pattern

## Spectronaut

Spectronaut has a outlier that has only 12 proteins.

```{r, fig.height = 5, fig.width = 5}
specMatMiss <- apply(as.matrix(is.na(assay(seSpec[, -which(colnames(seSpec) %in% "S454710")]))), 2, as.numeric)
colAnno <- smpAnno %>% 
  mutate(diag = ifelse(diag %in% c("CLL", "healthy", "MCL", "HCL", "SMZL", "MZL"), diag, "other")) %>%
  select(smpID, diag, pelletSize) %>%
  column_to_rownames("smpID") %>%
  as.data.frame()

pheatmap(specMatMiss, show_rownames = FALSE, show_colnames = FALSE, treeheight_row = 0, treeheight_col = 0,
         annotation_col = colAnno)

missRateSpec <- tibble(rate = rowSums(specMatMiss)/ncol(specMatMiss),
                       software = "spectronaut")
```

```{r}
plot_detect(seSpec[ , -which(colnames(seSpec) %in% "S454710")])
```

## DIANN

```{r,fig.height = 5, fig.width = 5}
diannMatMiss <- apply(as.matrix(is.na(assay(seDiann))), 2, as.numeric)
pheatmap(diannMatMiss, show_rownames = FALSE, show_colnames = FALSE, treeheight_row = 0, treeheight_col = 0,
         annotation_col = colAnno)

missRateDiann <- tibble(rate = rowSums(diannMatMiss)/ncol(diannMatMiss),
                       software = "diann")
```

```{r}
plot_detect(seDiann)
```

## Compare Spectronaut and DIANN

```{r}
missRateCom <- bind_rows(missRateSpec, missRateDiann)
ggplot(missRateCom, aes(x = rate, fill = software)) +
  geom_density(position = "identity", alpha = 0.5) +
  xlab("missing value rate") +
  theme_bw() +
  theme(axis.text = element_text(size=15),
        axis.title = element_text(size=15))
```

```{r, fig.height = 4, fig.width = 6}
missCutDF <- lapply(seq(0, 1, by = 0.1), function(cutoff){
  data <- missRateCom %>%
    mutate(id = paste0("id", nrow(.))) %>%
    group_by(software) %>%
    summarise(`Cumulative proportion` = sum(rate <= cutoff)/length(id)) %>%
    ungroup()
  data$`missRate cutoff` <- cutoff
  data
}) %>% bind_rows()
missCutDF %>% ggplot(aes(x = `missRate cutoff`, y = `Cumulative proportion`, col = software)) +
  geom_line(size = 2) +
  theme_bw() +
  xlab("Allowed missing value rate") +
  ylab("Remaining proteins (%)") +
  theme(axis.text = element_text(size = 15),
        axis.title = element_text(size = 15))
```

# Compare at protein levels

## Commonly detected proteins

### Gene level

```{r}
ggvenn::ggvenn(list("DIANN" = unique(rowData(seDiann)$geneID), 
                    "Spectronaut" = unique(rowData(seSpec)$geneID))) +
  ggtitle("Gene level") +
  theme(plot.title = element_text(hjust = 0.5, size = 15))
```

At least 50% detection rate

```{r}
seDiann.sub <- seDiann[rowSums(is.na(assay(seDiann)))/ncol(seDiann) < 0.5,]
seSpec.sub <- seSpec[rowSums(is.na(assay(seSpec)))/ncol(seSpec) < 0.5,]

#at least
ggvenn::ggvenn(list("DIANN" = unique(rowData(seDiann.sub)$geneID), 
                    "Spectronaut" = unique(rowData(seSpec.sub)$geneID))) +
  ggtitle("After filter proteins of 50% missing rate") +
  theme(plot.title = element_text(hjust = 0.5, size = 15))
```

## protein level

```{r}
ggvenn::ggvenn(list("DIANN" = unique(rowData(seDiann)$protID), 
                    "Spectronaut" = unique(rowData(seSpec)$protID)), text_size = 6)+
  ggtitle("Protein level") +
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"))
```

At least 50% detection rate

```{r}
#at least
ggvenn::ggvenn(list("DIANN" = unique(rowData(seDiann.sub)$protID), 
                    "Spectronaut" = unique(rowData(seSpec.sub)$protID))) +
  ggtitle("After filter proteins of 50% missing rate") +
  theme(plot.title = element_text(hjust = 0.5, size = 15))
```

## Expression level

```{r}
#define detection group
ll <- list("DIANN" = unique(rowData(seDiann)$protID), 
           "Spectronaut" = unique(rowData(seSpec)$protID))
detGroup <- list(onlyDiann = setdiff(ll$DIANN, ll$Spectronaut),
                 onlySpec = setdiff(ll$Spectronaut, ll$DIANN),
                 both = intersect(ll$DIANN, ll$Spectronaut))

vstTab.spec <- specMat.vst %>% as_tibble(rownames = "id") %>% pivot_longer(-id) %>% mutate(software = "Spectronaut", protID = rowData(seSpec)[id,]$protID) 
vstTab.diann <- diannMat.vst %>% as_tibble(rownames = "id") %>% pivot_longer(-id) %>% mutate(software = "DIANN", protID = rowData(seDiann)[id,]$protID)
vstTab <- bind_rows(vstTab.spec, vstTab.diann) %>%
  pivot_wider(names_from = software, values_from = value)
```

```{r, fig.height = 4, fig.width = 8}
plotTab <- mutate(vstTab, group = case_when(
    protID %in% detGroup$onlySpec ~ "only Spectronaut",
    protID %in% detGroup$onlyDiann ~ "only DIANN",
    protID %in% detGroup$both ~ "both"
  )) %>%
  pivot_longer(c(Spectronaut,DIANN), names_to = "software", values_to = "value")

ggplot(plotTab, aes(x = value, fill = group)) +
  geom_density(position = "identity", alpha = 0.5) +
  facet_wrap(~software) +
  theme_bw() +
  theme(axis.text = element_text(size = 15),
        axis.title = element_text(size = 15))
```

```{r, fig.height = 4, fig.width = 8}
missRateTab <- group_by(plotTab, group, protID, software) %>%
  summarise(missRate = sum(is.na(value))/length(name)) %>%
  filter(missRate <1)

ggplot(missRateTab, aes(x=missRate, fill = group)) +
  geom_density(position = "identity", alpha = 0.5) +
  facet_wrap(~software) +
  theme_bw() +
  theme(axis.text = element_text(size = 15),
        axis.title = element_text(size = 15))

```

```{r, fig.height = 4, fig.width = 8}
varTab <- group_by(plotTab, group, protID, software) %>%
  filter(!is.na(value)) %>%
  summarise(var = sd(value)/mean(value))

ggplot(varTab, aes(x = var, fill = group)) +
  geom_density(position = "identity", alpha=0.5) +
  facet_wrap(~software) +
  theme_bw() +
  theme(axis.text = element_text(size=15),
        axis.title = element_text(size=15))

```

## Reproducibility

```{r, warning = FALSE, message = FALSE}
corResTab <- filter(vstTab, !is.na(Spectronaut), !is.na(DIANN)) %>%
  select(-protID) %>%
  group_by(id) %>% 
  nest() %>%
  mutate(m = map(data, ~cor(.$Spectronaut,.$DIANN))) %>%
  mutate(res = map(m, broom::tidy)) %>%
  unnest(res)

ggplot(corResTab, aes(x=x)) +
  geom_histogram(fill = "lightblue", alpha = .5,col = "blue") +
  geom_vline(xintercept = median(corResTab$x), color = "red") +
  labs(x = "Pearson correlation coefficient", y = "Count", title = "Distribution of common protein correlation values \nin both software") +
  theme_bw()+
  theme(axis.text = element_text(size=20),
        axis.title = element_text(size=20, face = "bold"),
        plot.title = element_text(size = 20, face = "bold", hjust = 0.5))
```

# Reproducibility among replicates

## Within **healthy** donors

```{r}
#identify real replicates
patTab <- colData(seSpec) %>% as_tibble(rownames = "smpID") 
healthyTab <- filter(patTab, diag == "healthy")
table(healthyTab$patID)
```

Every healthy donors have replicates

### Spectronaut

PCA

```{r}
seSub <- seSpec[, healthyTab$smpID]
seSub <- seSub[rowSums(is.na(assay(seSub)))/ncol(seSub) < 0.5,]
exprMat.vst <- vsn::justvsn(assays(seSub)$count)
assay(seSub) <- exprMat.vst
seSub.imput <- DEP::impute(seSub, "QRILC")

pcRes <- prcomp(t(assay(seSub.imput)), center = TRUE, scale. = TRUE)

pcTab <- pcRes$x %>% as_tibble(rownames = "smpID") %>%
  left_join(healthyTab)

ggplot(pcTab, aes(x = PC1, y = PC2, col = patID)) +
  geom_point(aes(size = pelletSize, shape = sampleType)) +
  geom_line(linetype = "dotted") +
  theme_bw() + theme(axis.text = element_text(size = 15),
                     axis.title = element_text(size = 15))
```

Heatmap

```{r, fig.height = 8, fig.width = 10}
plotMat <- assay(seSub.imput)
colAnno <- healthyTab %>% select(smpID, patID, pelletSize, sampleID, sampleType) %>%
   column_to_rownames("smpID")
pheatmap(plotMat, annotation_col = colAnno, show_rownames = FALSE, show_colnames = FALSE, 
         scale = "row", treeheight_row = 0)
```

### DIANN

PCA

```{r}
seSub <- seDiann[, healthyTab$smpID]
seSub <- seSub[rowSums(is.na(assay(seSub)))/ncol(seSub) < 0.5,]
exprMat.vst <- vsn::justvsn(assays(seSub)$count)
assay(seSub) <- exprMat.vst
seSub.imput <- DEP::impute(seSub, "QRILC")

pcRes <- prcomp(t(assay(seSub.imput)), center = TRUE, scale. = TRUE)

pcTab <- pcRes$x %>% as_tibble(rownames = "smpID") %>%
  left_join(healthyTab)

ggplot(pcTab, aes(x = PC1, y = PC2, col = patID)) +
  geom_point(aes(size = pelletSize, shape = sampleType)) +
  geom_line(linetype = "dotted") +
  theme_bw() + theme(axis.text = element_text(size = 15),
                    axis.title = element_text(size = 15))
```

Heatmap

```{r, fig.height = 8, fig.width = 10}
plotMat <- assay(seSub.imput)
colAnno <- healthyTab %>% select(smpID, patID, pelletSize, sampleID, sampleType) %>%
   column_to_rownames("smpID")
pheatmap(plotMat, annotation_col = colAnno, show_rownames = FALSE, show_colnames = FALSE, 
         scale = "row", treeheight_row = 0)
```

## Within **CLL** samples

```{r}
#identify real replicates
cllTab <- filter(patTab, diag == "CLL", set =="CLL")
patNum <- table(cllTab$patID)

sort(patNum, decreasing = TRUE)
cllTab <- cllTab %>% filter(patID %in% names(patNum[patNum > 1]))
```

### Spectronaut

PCA

```{r}
seSub <- seSpec[, cllTab$smpID]
seSub <- seSub[rowSums(is.na(assay(seSub)))/ncol(seSub) < 0.5,]
exprMat.vst <- vsn::justvsn(assays(seSub)$count)
assay(seSub) <- exprMat.vst
seSub.imput <- DEP::impute(seSub, "QRILC")

pcRes <- prcomp(t(assay(seSub.imput)), center = TRUE, scale. = TRUE)

pcTab <- pcRes$x %>% as_tibble(rownames = "smpID") %>%
  left_join(cllTab)

ggplot(pcTab, aes(x = PC1, y = PC2, col = patID)) +
  geom_point(aes(size = pelletSize, shape = sampleType)) +
  geom_line(linetype = "dotted") +
  theme_bw() + theme(axis.text = element_text(size = 15),
                    axis.title = element_text(size = 15))
```

Heatmap

```{r, fig.height = 8, fig.width = 10}
plotMat <- assay(seSub.imput)
colAnno <- cllTab %>% select(smpID, patID, pelletSize, sampleType) %>%
   column_to_rownames("smpID")
pheatmap(plotMat, annotation_col = colAnno, show_rownames = FALSE, show_colnames = FALSE, 
         scale = "row", treeheight_row = 0)
```

### DIANN

PCA

```{r}
seSub <- seDiann[, cllTab$smpID]
seSub <- seSub[rowSums(is.na(assay(seSub)))/ncol(seSub) < 0.5,]
exprMat.vst <- vsn::justvsn(assays(seSub)$count)
assay(seSub) <- exprMat.vst
seSub.imput <- DEP::impute(seSub, "QRILC")

pcRes <- prcomp(t(assay(seSub.imput)), center = TRUE, scale. = TRUE)

pcTab <- pcRes$x %>% as_tibble(rownames = "smpID") %>%
  left_join(cllTab)

ggplot(pcTab, aes(x = PC1, y = PC2, col = patID)) +
  geom_point(aes(size = pelletSize, shape = sampleType)) +
  geom_line(linetype = "dotted") +
  theme_bw() + theme(axis.text = element_text(size = 15),
                    axis.title = element_text(size = 15))
```

Heatmap

```{r, fig.height = 8, fig.width = 10}
plotMat <- assay(seSub.imput)
colAnno <- cllTab %>% select(smpID, patID, pelletSize, sampleType ) %>%
   column_to_rownames("smpID")
pheatmap(plotMat, annotation_col = colAnno, show_rownames = FALSE, show_colnames = FALSE, 
         scale = "row", treeheight_row = 0)
```

# PCA of all samples and identify source of technical variations

## Spectronaut

Processing

```{r}
seSub <- seSpec[, -which(colnames(seSpec) %in% "S454710")]
seSub <- seSub[rowSums(is.na(assay(seSub)))/ncol(seSub) < 0.5, ]
exprMat.vst <- vsn::justvsn(assays(seSub)$count)
assay(seSub) <- exprMat.vst
seSub.imput <- DEP::impute(seSub, "QRILC")

patTab <- colData(seSub) %>% as_tibble(rownames = "smpID") %>%
  mutate(diagSimple = ifelse(diag %in% c("CLL", "healthy", "MCL", "HCL", "SMZL", "MZL"), diag, "other"))
```

### Perform PCA

```{r, fig.height = 8, fig.width = 8}
pcRes <- prcomp(t(assay(seSub.imput)), center = TRUE, scale. = TRUE)

pcTab <- pcRes$x %>% as_tibble(rownames = "smpID") %>%
  left_join(patTab)

ggplot(pcTab, aes(x = PC1, y = PC2, col = diagSimple, shape = sampleType)) +
  geom_point(aes(size = pelletSize)) +
  theme_bw() + theme(axis.text = element_text(size = 15),
                    axis.title = element_text(size = 15))

ggplot(pcTab, aes(x = PC3, y = PC4, col = diagSimple, shape = sampleType)) +
  geom_point(aes(size = pelletSize)) +
  theme_bw() + theme(axis.text = element_text(size = 15),
                    axis.title = element_text(size = 15))
```

## DIANN

Processing

```{r}
seSub <- seDiann
seSub <- seSub[rowSums(is.na(assay(seSub)))/ncol(seSub) < 0.5,]
exprMat.vst <- vsn::justvsn(assays(seSub)$count)
assay(seSub) <- exprMat.vst
seSub.imput <- DEP::impute(seSub, "QRILC")

patTab <- colData(seSub) %>% as_tibble(rownames = "smpID") %>%
  mutate(diagSimple = ifelse(diag %in% c("CLL", "healthy", "MCL", "HCL", "SMZL", "MZL"), diag, "other")) 
```

### Perform PCA

```{r, fig.height = 8, fig.width = 8}
pcRes <- prcomp(t(assay(seSub.imput)), center = TRUE, scale. = TRUE)

pcTab <- pcRes$x %>% as_tibble(rownames = "smpID") %>%
  left_join(patTab)

ggplot(pcTab, aes(x = PC1, y = PC2, col = diagSimple, shape = sampleType)) +
  geom_point(aes(size = pelletSize)) +
  theme_bw() + theme(axis.text = element_text(size = 15),
                     axis.title = element_text(size = 15))

ggplot(pcTab, aes(x = PC3, y = PC4, col = diagSimple, shape = sampleType)) +
  geom_point(aes(size = pelletSize)) +
  theme_bw() + theme(axis.text = element_text(size = 15),
                     axis.title = element_text(size = 15))
```

# PCA of **non-healthy** samples and **no low pellet** samples (pellet size \> 0.2)

## Spectronaut

Processing

```{r}
seSub <- seSpec[, -which(colnames(seSpec) %in% "S454710")]
seSub <- seSub[, seSub$diag != "healthy" & seSub$pelletSize > 0.2]
seSub <- seSub[rowSums(is.na(assay(seSub)))/ncol(seSub) < 0.5, ]
exprMat.vst <- vsn::justvsn(assays(seSub)$count)
assay(seSub) <- exprMat.vst
seSub.imput <- DEP::impute(seSub, "QRILC")

patTab <- colData(seSub) %>% as_tibble(rownames = "smpID") %>%
  mutate(diagSimple = ifelse(diag %in% c("CLL", "healthy", "MCL", "HCL", "SMZL", "MZL"), diag, "other")) 
```

### Perform PCA

```{r, fig.height = 8, fig.width = 8}
pcRes <- prcomp(t(assay(seSub.imput)), center = TRUE, scale. = TRUE)

pcTab <- pcRes$x %>% as_tibble(rownames = "smpID") %>%
  left_join(patTab)

ggplot(pcTab, aes(x = PC1, y = PC2, col = diagSimple, shape = sampleType)) +
  geom_point(aes(size = pelletSize)) +
    theme_bw() + theme(axis.text = element_text(size=15),
                     axis.title = element_text(size = 15))

ggplot(pcTab, aes(x = PC3, y = PC4, col = diagSimple, shape = sampleType)) +
  geom_point(aes( size= pelletSize)) +
  theme_bw() + theme(axis.text = element_text(size = 15),
                    axis.title = element_text(size = 15))
```

## DIANN

Processing

```{r}
seSub <- seDiann[, seDiann$diag != "healthy" & seDiann$pelletSize > 0.2]
seSub <- seSub[rowSums(is.na(assay(seSub)))/ncol(seSub) < 0.5,]
exprMat.vst <- vsn::justvsn(assays(seSub)$count)
assay(seSub) <- exprMat.vst
seSub.imput <- DEP::impute(seSub, "QRILC")

patTab <- colData(seSub) %>% as_tibble(rownames = "smpID") %>%
  mutate(diagSimple = ifelse(diag %in% c("CLL", "healthy", "MCL", "HCL", "SMZL", "MZL"), diag, "other")) 
```

### Perform PCA

```{r, fig.height = 8, fig.width = 8}
pcRes <- prcomp(t(assay(seSub.imput)), center = TRUE, scale. = TRUE)

pcTab <- pcRes$x %>% as_tibble(rownames = "smpID") %>%
  left_join(patTab)

ggplot(pcTab, aes(x = PC1, y = PC2, col = diagSimple, shape = sampleType)) +
  geom_point(aes(size = pelletSize)) +
  theme_bw() + theme(axis.text = element_text(size = 15),
                     axis.title = element_text(size = 15))

ggplot(pcTab, aes(x = PC3, y = PC4, col = diagSimple, shape = sampleType)) +
  geom_point(aes(size = pelletSize)) +
  theme_bw() + theme(axis.text = element_text(size = 15),
                     axis.title = element_text(size = 15))
```
